#!/usr/bin/env node
const CgiNodeConfig={Version:"0.2",StartTag:"<?",EndTag:"<?",ScriptExtensions:[".js"],EmbededScriptExtensions:[".jss"],SessionCookie:"CGI-NODE-SESSIONID",SessionTimeOut:900,SessionPath:"D:/Programs/nodejs/sessions/"};function CgiHttpContext(e){var t=this;this.__scripts=[],this.__vmContext=null,this.request=new CgiHttpRequest(e),this.response=new CgiHttpResponse,
this.session=new CgiHttpSession(this.request,this.response),this.write=this.response.write,this.process=process,this.require=require,this.mapPath=function(e){var s=Path.dirname(t.request.server.path_translated);return Path.resolve(s,e)},this.include=function(e,s){void 0===s&&(s={encoding:"utf8"});var i=t.mapPath(e),r=FS.readFileSync(i,s)
;".js"!=Path.extname(e)?script=CgiParser.script(t.__scripts.length,i,r.toString()):script={id:t.__scripts.length,path:i,script:null,code:r,content:[]},t.__scripts.push(script),null===t.__vmContext&&(t.__vmContext=VM.createContext(t)),VM.runInContext(script.code,t.__vmContext,script.path)},this.cgiNodeInfo=function(){var e=function(e,s){
for(var i in t.response.write('<tr><th colspan="2">'+e+"</th></tr>"),s){var r=s[i];if("function"!=typeof r){if("object"==typeof r){var o='<table class="NodeASPTable" border="0" style="margin: 0px">';for(var n in r)o+="<tr><td>"+n+"</td><td>"+r[n]+"</td></tr>";r=o+"</table>"}process.stdout.write("<tr><td>"+i+"</td><td>"+r+"</td></tr>")}}}
;t.response.write("<style>.Logo{ text-align: left; font-size: 36px !important; } .NodeASPTable{ font-family: arial; font-size: 12px; margin: auto; border-collapse: collapse; width: 600px} .NodeASPTable TH{ background-color: #303030; color: white; font-size: 14px; padding: 10px} .NodeASPTable TD{ padding: 5px; } .NodeASPTable TR TD:nth-child(1){ background: #d9ebb3; }</style>"),
t.response.write('<table class="NodeASPTable" border="1">'),t.response.write('<tr><th colspan="2" class="Logo">CGI-NODE v'+CgiNodeConfig.Version+"</th></tr>");var s={id:t.session.id,path:t.session.path,ipAddress:t.session.ipAddress};e("Node Versions",process.versions),e("CGI Command Line Arguments",process.argv),e("Server Variables",t.request.server),e("HTTP Request Headers",t.request.headers),
e("HTTP Request Cookies",t.request.cookies),e("Session",s),e("Session Cookies",t.session.cookies),e("Session Data",t.session.data),e("URL Query String",t.request.query),e("Post Form",t.request.post.form),e("Post Files",t.request.post.files),e("Post Parts",t.request.post.parts),t.response.write("</table>")}}function CgiHttpSession(e,t){var s=this;this.id=null,this.path=null,this.ipAddress=null,
this.cookies={},this.data={},this.init=function(){e.session=this,t.session=this,this.id=e.cookies.hasOwnProperty(CgiNodeConfig.SessionCookie)?e.cookies[CgiNodeConfig.SessionCookie]:this.create();var s=Path.join(CgiNodeConfig.SessionPath,this.id);FS.existsSync(s)||(this.id=this.create());var i=JSON.parse(FS.readFileSync(Path.join(CgiNodeConfig.SessionPath,this.id)))
;if(i.ipAddress!=e.server.remote_addr)throw"Invalid session ID!";for(name in i)this[name]=i[name]},this.save=function(){var e={id:s.id,path:s.path,ipAddress:s.ipAddress,cookies:s.cookies,data:s.data};FS.writeFileSync(s.path,JSON.stringify(e))},this.create=function(){
var t=new Date,s=e.server.remote_addr+e.server.remote_port+e.server.unique_id+t.value+Math.random(),i=Crypto.createHash("md5").update(s).digest("hex"),r={id:i,path:Path.join(CgiNodeConfig.SessionPath,i),ipAddress:e.server.remote_addr,cookies:{},data:{}};return r.cookies[CgiNodeConfig.SessionCookie]={name:CgiNodeConfig.SessionCookie,value:i,httpOnly:!0,notSent:!0,server:!0},
FS.writeFileSync(r.path,JSON.stringify(r)),r.id},this.cleanUp=function(){for(var e=(new Date).value,t=1e3*CgiNodeConfig.SessionTimeOut,s=FS.readdirSync(CgiNodeConfig.SessionPath),i=0;i<s.length;i++){var r=Path.join(CgiNodeConfig.SessionPath,s[i]);FS.statSync(r).mtime.value+t<e&&FS.unlinkSync(r)}},this.init()}function CgiHttpResponse(){var e=this;this.session=null,this.isHeaderSent=!1,
this.headers={"content-type":"text/html; charset=iso-8859-1"},this.sendHeaders=function(){if(!e.isHeaderSent){for(var t in e.isHeaderSent=!0,e.headers)process.stdout.write(t+":"+e.headers[t]+"\r\n");for(var t in e.session.cookies){var s=e.session.cookies[t];!0===s.notSent&&(delete s.notSent,process.stdout.write("Set-Cookie:"+CgiParser.serializeCookie(s)+"\r\n"))}process.stdout.write("\r\n")}},
this.write=function(t){e.sendHeaders(),process.stdout.write(t.toString())},this.end=function(){e.sendHeaders(),process.exit()}}function CgiHttpRequest(){var e=this;this.url=null,this.method=null,this.httpVersion=null,this.query={},this.post={form:{},files:[],parts:[],data:"",isMultiPart:!1},this.server={},this.headers={},this.cookies={},this.form={},this.init=function(){
CgiParser.enviromentVarialbesAndHeaders(process.env,this.server,this.headers),this.method=this.server.request_method,this.httpVersion=this.server.server_protocol,this.headers.content_type=this.server.hasOwnProperty("content_type")?this.server.content_type:"",this.headers.content_length=this.server.hasOwnProperty("content_length")?this.server.content_length:0,
this.headers.hasOwnProperty("cookie")&&(this.cookies=CgiParser.cookies(this.headers.cookie)),this.url=URL.parse(this.server.request_uri,!0),this.query=this.url.query,e.post.isMultiPart=this.headers.content_type.toLowerCase().indexOf("multipart/form-data")>-1},this.readPost=function(t,s){void 0===s&&(s=!0),process.stdin.on("data",(function(t){e.post.data+=t})),process.stdin.on("end",(function(){
s&&e.parsePost(),t&&t()}))},this.parsePost=function(){e.post.isMultiPart?CgiParser.multiPart(e.post.data,e.post):e.post.form=QueryString.parse(e.post.data)},this.init()}var CgiParser={script:function(e,t,s){for(var i="response.write( __scripts["+e+"].content[",r={id:e,path:t,code:"",content:[]},o=0,n=0;o<s.length;){if((o=s.indexOf("<?",n))>=0){o>n&&(r.code+=i+r.content.length+"]);",
r.content.push(s.slice(n,o)));var a="="==s[n=o+"<?".length]?n++:-1;if(!((o=s.indexOf("?>",n))>=0))throw new Error("Missing close tag ?>");r.code+=a>0?"response.write( "+s.slice(n,o)+" ); ":s.slice(n,o)+";",n=o+"?>".length}else o=s.length,r.code+=i+r.content.length+"]);",r.content.push(s.slice(n,o))}return r},enviromentVarialbesAndHeaders:function(e,t,s){for(var i in e){var r=e[i]
;0===(i=i.toLowerCase()).indexOf("http_")?s[i.substring("http_".length)]=r:t[i]=r}},multiPart:function(e,t){void 0===t&&(t={form:{},files:{},parts:[]});e.length;var s,i=0;s=e.indexOf("\n");var r=e.substring(i,s-1);i=s+1,t.parts=e.split(r);for(var o=0;o<t.parts.length;o++);return t},serializeCookie:function(e){var t=[e.name+"="+encodeURIComponent(e.value)]
;return e.domain&&t.push("Domain="+e.domain),e.path&&t.push("Path="+e.path),e.expires&&t.push("Expires="+e.expires.toUTCString()),e.httpOnly&&t.push("HttpOnly"),t.join("; ")},cookies:function(e){for(var t=e.split(";"),s={},i=0;i<t.length;i++){var r=t[i],o=r.indexOf("=");if(!(o<0)){var n=r.substr(0,o).trim(),a=r.substr(o+1,r.length).trim();'"'==a[0]&&(a=a.slice(1,-1));try{s[n]=decodeURIComponent(a)
}catch(e){s[n]=a}}}return s}};const VM=require("vm"),FS=require("fs"),URL=require("url"),Path=require("path"),Crypto=require("crypto"),QueryString=require("querystring");let cgiNodeContext=new CgiHttpContext;process.on("uncaughtException",(function(e){var t='<br/><div style="color:red"><b>EXCEPTION</b>: '+e.message+"<i><pre>"+e.stack+"</pre></i></div></br>"
;null!==cgiNodeContext?cgiNodeContext.response.write(t):process.stdout.write("Content-type: text/html; charset=iso-8859-1\n\n"+t)})),process.on("exit",(function(e){cgiNodeContext.session.save(),cgiNodeContext.session.cleanUp()}));var onReady=function(){cgiNodeContext.include(process.env.PATH_TRANSLATED)};cgiNodeContext.request.method="GET",
"POST"!=cgiNodeContext.request.method?onReady():cgiNodeContext.request.readPost(onReady);